package controller;

import java.io.IOException;
import java.util.ArrayList;

import components.PlayerHand;
import engine.Game;
import engine.board.Cell;
import exception.CannotFieldException;
import exception.GameException;
import exception.IllegalDestroyException;
import exception.InvalidCardException;
import exception.InvalidMarbleException;
import javafx.animation.Animation;
import javafx.animation.KeyFrame;
import javafx.animation.Timeline;
import javafx.scene.Cursor;
import javafx.scene.Node;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.TextField;
import javafx.scene.control.ToggleButton;
import javafx.scene.effect.DropShadow;
import javafx.scene.paint.Color;
import javafx.scene.shape.Circle;
import javafx.util.Duration;
import model.Colour;
import model.card.Card;
import model.card.standard.Standard;
import model.player.Marble;
import model.player.Player;
import view.Main;


public class GameController {
	Game game;
	String name;
	
<<<<<<< HEAD
	public GameController() throws IOException{
		this.game = new Game(name);
		this.name = "";
=======

	public GameController(String name) throws IOException{
		this.game = new Game(name);


>>>>>>> refs/remotes/origin/new
	}
	
	
	public void SetName(Main app,Label message,TextField NameField){
		String userInput = NameField.getText();
		if(!NameField.getText().equals(""))
			try {
				app.showSceneTwo(userInput);
			} catch (Exception e) {
				// TODO Auto-generated catch block
				Main.showAlert("Exception", e.getMessage());
			}
		else
			message.setText("Input your name");
		
	}
	//public void updateCards
	// create method updateCards , which takes the hand of the player in the GUI and changes its value to match with the value in game
	
	
	public void updateCards(PlayerHand hand){
		ArrayList<Card> cards = game.getPlayers().get(0).getHand();
		hand.getChildren().clear();
		for(Card card: cards) {
        	ToggleButton currToggle= hand.addCard(card);
        	
        	currToggle.setOnMouseClicked(event -> {
        		
        		
        		
        		
        		for( Node n : hand.getChildren()){
        			ToggleButton curr=(ToggleButton) n;
        			curr.setStyle("");
        			curr.setPrefSize(70, 100);
        		}
        		currToggle.setPrefSize(80, 110);
        		currToggle.setStyle(
        			    "-fx-border-color: black;" +
        			    "-fx-border-width: 5;" +
        			    "-fx-border-radius: 5;" +
        			    "-fx-background-radius: 5;" +// Optional: matches rounded corners
        			    "-fx-padding: 5;"
        			);
        		
        		
        		System.out.println("Card in toggle: " + card.getName());
        		System.out.println("Hand contains card? " + cards.contains(card));
        		System.out.println("Player hand:");
        		for (Card c : cards) {
        		    System.out.println(c.getName() + " | equals? " + c.equals(card));
        		}
        		
        		Card selected=(Card)currToggle.getUserData();
        		Boolean alert = this.selectCard(selected);
                System.out.println("Selected card: " + selected.getName());  // Debug log
                if(!alert) {Main.showAlert("Invalid Card Exception", "Chosen card is not in your hand");}
            });
    		
    		currToggle.setOnMouseEntered(e -> {currToggle.setScaleX(1.1);
    		currToggle.setTranslateX(10);
    		currToggle.setTranslateY(-10);
    		currToggle.setCursor(Cursor.HAND);
    		DropShadow shadow = new DropShadow();
    		currToggle.setEffect(shadow);
    		});
    		
    		
    		
    		currToggle.setOnMouseExited(e -> {currToggle.setScaleX(1.0);
    		currToggle.setTranslateX(0);
    		currToggle.setTranslateY(0);
    		currToggle.setCursor(Cursor.DEFAULT);
    		currToggle.setEffect(null);
    		});

    		
            
    	
        }
		
	}
	
	

	
	//public void selectMarble
		// create method selectMarble, which takes as the parameter an index number and the circle clicked and sets the selected marble in the game 
		public void selectMarble(ArrayList<ArrayList<Circle>> safeZones ,ArrayList<Circle> trackCircles, Circle circle){
			Marble m ;
			int indexTrack = -1;
			int indexSafe = -1;
			for(int i = 0 ; i < trackCircles.size(); i++){
				if(trackCircles.get(i).equals(circle)){
					indexTrack = i;
				}
			}
			for(int i = 0 ; i < safeZones.get(game.getcurrentPlayerIndex()).size(); i++){
				if(safeZones.get(i).equals(circle)){
					indexSafe = i;
				}
			}
			if(indexTrack != -1)
				m = this.game.board.getTrack().get(indexTrack).getMarble(); //to get the corrosponding marble if it is on the track
				
			else{
				m = this.game.board.getSafeZones().get(game.getcurrentPlayerIndex()).getCells().get(indexTrack).getMarble();//to get the corrosponding marble if it is on the player's safezone
			}
			if(m!= null){
				try {
					game.selectMarble(m);
				} catch (InvalidMarbleException e) {
					Main.showAlert("Exception", e.getMessage());
				}
			}
			
		}
		
	
	
	
	//public void selectCard
	// create method selectMarble, which takes as the parameter the Card clicked and sets the selected card in the game 
		public boolean selectCard(Card card){
			
			System.out.println("Controller: "+card.getName());
			
			try{
				game.selectCard(card);
				
			}catch(InvalidCardException e) { //can only access the player's hand aslan. whats the use?? 
				return false;
			}
			
			return true;
		}
		
	
	//
	
	public ArrayList<ArrayList<Card>> getHands(){
		ArrayList<ArrayList<Card>> hands=new ArrayList<ArrayList<Card>>();
		
		ArrayList<Player> players=game.getPlayers();
		
		for(Player curr : players) {
			hands.add(curr.getHand());
		}
		
		
		return hands;
	}
	

	//public void fieldmarble
		// takes as argument all the base cells and the track from the GUI and removes one , and adds it to the track ( updating it also in the game class )
		public void fieldMarble(ArrayList<ArrayList<Circle>> baseZones, ArrayList<Circle> trackCircles){
			try {
				game.fieldMarble();
				updateBase(baseZones);
				updateBoard(trackCircles);
				//baseZones.get(game.getcurrentPlayerIndex())
			} catch (CannotFieldException e) {
				// TODO Auto-generated catch block
				Main.showAlert("Exception", e.getMessage());
			} catch (IllegalDestroyException e) {
				// TODO Auto-generated catch block
				Main.showAlert("Exception", e.getMessage());
			}
			
			
		}
		
		// public void updateBoard
		// create method updateBoard , which takes the board circles and updates them according to the game instance
		public void updateBoard(ArrayList<Circle> trackCircles){
			ArrayList<Cell> trackCells = game.board.getTrack();
			// GREEN, RED, YELLOW, BLUE
			for(int i = 0 ; i < trackCells.size(); i++){
				if(trackCells.get(i).getMarble() != null){
					Colour c = trackCells.get(i).getMarble().getColour();
					Color GUIColor = translatecolortocolor(c);
					trackCircles.get(i).setFill(GUIColor);
				}else{
					trackCircles.get(i).setFill(Color.GRAY);
				}
			}
		}
		
		public void updateBase(ArrayList<ArrayList<Circle>> baseZones){
			for(int homeCount = 0 ; homeCount < 4 ; homeCount ++){
				int homesize = game.getPlayers().get(homeCount).getMarbles().size();
				
				for(int i=0; i < 4;i++){
					baseZones.get(homeCount).get(i).setVisible(true);
					if(i > homesize-1)
						baseZones.get(homeCount).get(i).setVisible(false);
						
					}
			}
				
			}
		
		public void updateSafe(ArrayList<ArrayList<Circle>> safeZones){
			for(int safeCount = 0 ; safeCount < 4 ; safeCount ++){
				ArrayList<Cell> cells = game.board.getSafeZones().get(safeCount).getCells();
				Colour c = game.board.getSafeZones().get(safeCount).getColour();
				for(int i=0; i<4;i++){
					if(cells.get(i).getMarble() != null){
						safeZones.get(safeCount).get(i).setFill(translatecolortocolor(c));
					}else{
						safeZones.get(safeCount).get(i).setFill(Color.GRAY);
					}
					
				}
			}
		}
		
		//to translate engine color to the GUI color format
		public static Color translatecolortocolor(Colour playerColor){
				if(playerColor.equals(Colour.GREEN))
					return Color.GREEN;
				else if (playerColor.equals(Colour.RED))
					return Color.RED;
				else if (playerColor.equals(Colour.YELLOW))
					return Color.YELLOW;
				else if (playerColor.equals(Colour.BLUE))
					return Color.BLUE;
			return Color.BLACK;
		}
		
		public ArrayList<Colour> getPlayerColours(){
			ArrayList<Player> players= game.getPlayers();
			ArrayList<Colour> playerColors=new ArrayList<Colour>();
			for(Player player : players){
				Colour currColor=player.getColour();
				playerColors.add(currColor);
			}
			
			return playerColors;
		}
		
		//public void playGUI
		// responsible for playing a players turn
		public void playGUI(ArrayList<ArrayList<Circle>> safeZones,
                ArrayList<ArrayList<Circle>> baseZones,
                ArrayList<Circle> trackCircles,
                PlayerHand hand, Button play) {

		try {
			System.out.println(game.getPlayers().get(0).getSelectedCard().getName());
			System.out.println("GUI Curr ind: " + game.getcurrentPlayerIndex());
		    if (game.canPlayTurn()) {
		        game.playPlayerTurn();
		        updateBase(baseZones);
		        updateSafe(safeZones);
		        updateBoard(trackCircles);
		        
		    }
		    game.endPlayerTurn();
		    if(game.checkWin() != null){
            	System.out.println("YOU WINNNNN !");
            }
	        
	        updateCards(hand);
		    play.setDisable(true);

		
		    final int[] i = { 0 };
		    Timeline timeline = new Timeline();
		    
		    KeyFrame frame = new KeyFrame(
		        Duration.seconds(2),
		        event -> {
		            if (i[0] < 3) {
		                if (game.canPlayTurn()) {
		                        try {
									game.playPlayerTurn();
									updateBase(baseZones);
			                        updateSafe(safeZones);
			                        updateBoard(trackCircles);

								} catch (Exception e) {
									Main.showAlert("Exception", e.getMessage());
								}
		                }
		                game.endPlayerTurn();// to be checked
                        if(game.checkWin() != null){
                        	System.out.println("YOU LOSTTT !");
                        }
                        updateCards(hand);


		                i[0]++;
		                System.out.println("CPU played");
		                if(game.getPlayers().get(game.getcurrentPlayerIndex()).getSelectedCard()==null) {System.out.println("null");}
		                else{System.out.println(game.getPlayers().get(game.getcurrentPlayerIndex()).getSelectedCard().getName());}
		            } else {
		            	play.setDisable(false);
		            	game.deselectAll();
		                timeline.stop();   // â† directly call stop() on the captured variable
		            }
		        }
		    );

		    timeline.getKeyFrames().add(frame);
		    timeline.setCycleCount(Animation.INDEFINITE);
		    timeline.play();
		    
		
		} catch (GameException e) {
			Main.showAlert("Exception", e.getMessage());
		}
}

		
	
	

	
}
